name: Auto Merge on PR Approval

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    if: |
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'develop'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Auto Merge PR if Approved
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number || context.payload.review.pull_request_number;

            try {
              // PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              if (pr.data.merged) {
                console.log('PRì´ ì´ë¯¸ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
              }

              // ë¨¸ì§€ ê°€ëŠ¥ ìƒíƒœ í™•ì¸ (mergeable: true = ì¶©ëŒ ì—†ìŒ)
              if (!pr.data.mergeable) {
                console.log('PRì— ì¶©ëŒì´ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                core.setFailed('PRì— ì¶©ëŒì´ ìˆì–´ ìë™ ë¨¸ì§€ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              // ë¨¸ì§€ ê°€ëŠ¥ ìƒíƒœê°€ ê³„ì‚° ì¤‘ì´ë©´ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë‹¤ì‹œ ì‹œë„
              if (pr.data.mergeable_state === 'unknown') {
                console.log('mergeable ìƒíƒœê°€ ì•„ì§ ê³„ì‚°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                core.setFailed('mergeable_state: unknown');
                return;
              }

              // ëª¨ë“  ë¦¬ë·° í™•ì¸
              const reviews = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              // ê° ë¦¬ë·°ì–´ì˜ ìµœì‹  ë¦¬ë·° ìƒíƒœë§Œ í™•ì¸
              const latestReviews = new Map();
              reviews.data.forEach(review => {
                latestReviews.set(review.user.login, review.state);
              });

              const hasRejection = Array.from(latestReviews.values()).includes('CHANGES_REQUESTED');
              const approvalCount = Array.from(latestReviews.values()).filter(state => state === 'APPROVED').length;

              if (!hasRejection && approvalCount >= 1) {
                console.log('âœ… ìŠ¹ì¸ë¨. ìë™ ë¨¸ì§€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤...');
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash' // ë˜ëŠ” 'merge', 'rebase'
                });
              } else {
                console.log('ğŸ™… ìŠ¹ì¸ë˜ì§€ ì•Šì•˜ê±°ë‚˜ CHANGES_REQUESTEDê°€ ìˆìŠµë‹ˆë‹¤.');
              }
            } catch (error) {
              console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
              core.setFailed(error.message);
            }